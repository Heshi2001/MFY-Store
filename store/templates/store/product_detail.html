{% extends "store/base.html" %}
{% load static %}
{% load reviews %}
{% load ratings %}

{% block content %}

<script type="application/ld+json">
  {
    "@context": "https://schema.org/",
    "@type": "Product",
    "name": "{{ product.name }}",
    "image": ["{{ product.get_main_image_url }}"],
    "description": "{{ product.description|striptags }}",
    "sku": "MFY-{{ product.id }}",
    "offers": {
      "@type": "Offer",
      "priceCurrency": "INR",
      "price": "{{ product.display_price }}",
      "availability": "{% if product.in_stock %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}"
    }
  }
  </script>

<style>
.color-box {
  background-color: var(--color-value);
}
.mobile-nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  background:rgba(0,0,0,0.6);
  color:white;
  width:40px;
  height:40px;
  border-radius:999px;
  font-size:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20;
}

.mobile-nav.prev{ left:12px; }
.mobile-nav.next{ right:12px; }

/* ðŸ”¥ Main image fade */
.main-image {
  transition: opacity 0.35s ease-in-out, transform 0.35s ease-in-out;
}
.main-image.fade-out {
  opacity: 0;
}

/* ===============================
   IMAGE ZOOM (DESKTOP + MOBILE)
================================ */

/* Desktop hover zoom */
@media (min-width: 768px) {
  #main-product-image {
    transition: transform 0.35s ease, opacity 0.35s ease;
  }

  #main-product-image:hover {
    transform: scale(1.15);
  }
}

/* Mobile double-tap zoom */
.mobile-slide {
  transition: transform 0.35s ease, opacity 0.35s ease;
  transform-origin: center center;
}

.mobile-slide.zoomed {
  transform: scale(2);
  z-index: 30;
}

</style>

<section class="bg-[#020617] text-gray-300 min-h-screen animate-fadeIn pt-32 md:pt-36">

  <nav class="max-w-7xl mx-auto px-4 pt-6 text-sm" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2 text-gray-400">
      <li><a href="{% url 'index' %}" class="hover:text-emerald-400 transition">Home</a></li>
      <li>/</li>
      <li><a href="{% url 'products' %}" class="hover:text-emerald-400 transition">Products</a></li>
      <li>/</li>
      <li class="text-gray-200 truncate">{{ product.name }}</li>
    </ol>
  </nav>

  <div class="max-w-7xl mx-auto px-4 py-10 grid grid-cols-1 lg:grid-cols-2 gap-10">

<div class="relative">

  <div class="hidden md:flex gap-4">
  <div class="flex flex-col gap-3">
    {% if images %}
      {% for img in images %}
        <img src="{{ img.image.url }}"
             data-thumb="{{ img.image.url }}"
             alt="{{ product.name }} thumbnail"
             class="main-image thumb-img w-20 h-24 object-contain bg-black/30 p-1 rounded-xl cursor-pointer
                   border border-white/10 hover:border-emerald-400 transition" />
      {% endfor %}
    {% else %}
      <img src="{{ product.get_main_image_url }}"
           class="thumb-img w-20 h-24 object-contain bg-black/30 p-1 rounded-xl"
           alt="Placeholder" />
    {% endif %}
  </div>

  <div class="flex-1 bg-black/40 rounded-2xl shadow-lg shadow-emerald-500/10 flex items-center justify-center">
    <img id="main-product-image"
         src="{{ images.0.image.url|default:product.get_main_image_url }}"
         alt="{{ product.name }}"
         class="w-full h-[520px] object-contain transition-transform duration-500 hover:scale-[1.02]" />
  </div>
</div>

<!-- ðŸ“± Mobile Carousel (FIXED) -->
<div class="md:hidden relative bg-black/40 rounded-2xl overflow-hidden">

  <div class="relative w-full h-[420px]" id="mobile-carousel">
    {% if images %}
      {% for img in images %}
        <img src="{{ img.image.url }}"
             alt="{{ product.name }}"
             class="mobile-slide absolute inset-0 w-full h-full
                    object-contain transition-opacity duration-300
                    {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}">
      {% endfor %}
    {% else %}
      <img src="{{ product.get_main_image_url }}"
           class="mobile-slide absolute inset-0 w-full h-full object-contain opacity-100"
           alt="Placeholder">
    {% endif %}
  </div>

  <button class="mobile-nav prev">â€¹</button>
  <button class="mobile-nav next">â€º</button>

</div>
</div>

<!-- RIGHT : Product Info -->
<div class="space-y-6">

  <h1 class="text-3xl font-semibold text-white">{{ product.name }}</h1>
  <p class="text-gray-400 leading-relaxed">{{ product.description }}</p>

  <div class="flex items-center gap-4" id="price-block">
  {% if base_variant and base_variant.offer_price %}
    <span class="text-gray-500 line-through" id="base-price">
      â‚¹{{ base_variant.price }}
    </span>
    <span class="text-3xl font-bold text-emerald-400" id="current-price">
      â‚¹{{ base_variant.offer_price }}
    </span>
  {% elif base_variant %}
    <span class="text-3xl font-bold text-white" id="current-price">
      â‚¹{{ base_variant.price }}
    </span>
  {% endif %}
</div>

  <div class="flex flex-wrap gap-4 text-sm">
    <span class="flex items-center gap-2">ðŸ”’ Secure Payment</span>
    <span class="flex items-center gap-2">ðŸšš Ships in 24â€“48 hrs</span>
    <span class="flex items-center gap-2">âœ” In Stock</span>
  </div>

  <!-- COLORS -->
  {% if variants %}
  <div class="mt-6">
    <p class="text-sm text-gray-400 mb-2">Color</p>
    <div class="flex gap-4">
      {% for variant in variants %}
        <div class="text-center">
          <span class="color-box w-10 h-10 rounded-full border-2 border-white/20 inline-block"
                data-color-id="{{ variant.color.id }}"
                style="--color-value: {{ variant.color.hex_code }};"></span>
          <div class="text-xs mt-1">{{ variant.color.name }}</div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- CTA -->
  <div class="pt-6 flex gap-4">
    <button class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-black py-3 rounded-xl font-semibold">
      Add to Cart
    </button>
    <button id="wishlist-btn" type="button" class="relative w-14 h-14 border border-white/20 rounded-xl flex items-center justify-center">

<span id="heart" class="text-xl transition-transform">â™¡</span> </button> </div>

</div>

  </div>
<!-- ðŸ”½ Accordions -->
<section class="max-w-7xl mx-auto px-4 pb-20">
  <div class="space-y-3">
    <details class="bg-white/5 rounded-xl p-4"><summary class="cursor-pointer text-white">Fabric Care</summary><p class="text-gray-400 mt-2 text-sm">Machine wash cold. Do not bleach.</p></details>
    <details class="bg-white/5 rounded-xl p-4"><summary class="cursor-pointer text-white">Shipping</summary><p class="text-gray-400 mt-2 text-sm">Ships within 24â€“48 hours.</p></details>
    <details class="bg-white/5 rounded-xl p-4"><summary class="cursor-pointer text-white">Returns</summary><p class="text-gray-400 mt-2 text-sm">7-day easy returns.</p></details>
  </div>

  <!-- ðŸ•˜ Recently Viewed -->

  <div class="mt-12">
    <h2 class="text-xl text-white mb-4">Recently Viewed</h2>
    <div id="recentlyViewed" class="flex gap-4 overflow-x-auto"></div>
  </div>
</section>
</section>

<!-- ðŸ•’ Recently Viewed Products -->

<section class="max-w-7xl mx-auto px-4 pb-16" id="recently-viewed" hidden>
  <h2 class="text-xl text-white mb-4">Recently Viewed</h2>
  <div class="flex gap-4 overflow-x-auto"></div>
</section>

<style>
  .color-box { background-color: var(--color-value); }
</style>

<!-- ðŸ”¥ Mobile Sidebar CTA -->
<div class="sticky bottom-0 bg-black/90 backdrop-blur border-t border-white/10">
  <form method="POST"
        action="{% url 'add_to_cart' product.id %}"
        class="flex items-center gap-3 p-3">
    {% csrf_token %}

    <span
      id="mobile-current-price"
      class="text-white font-semibold flex-1"
    ></span>

    <button
      type="submit"
      class="bg-emerald-500 text-black font-semibold px-6 py-3 rounded-xl"
    >
      Add to Cart
    </button>
  </form>
</div>

{% endblock %}

{% block page_js %}
<script>
(function () {
  /* ======================================================
     CONFIG (SAFE DJANGO â†’ JS)
  ====================================================== */
  const PRODUCT_ID = Number("{{ product.id }}");
  const PRODUCT_NAME = "{{ product.name|escapejs }}";
  const BASE_PRICE = {{ base_price_data|safe }};
  const VARIANTS = {{ variant_map|safe }};
  const RV_KEY = "mfy_recently_viewed";

  /* ======================================================
     DOM REFERENCES
  ====================================================== */
  const mainImage =
    document.querySelector('[data-main-image]') ||
    document.getElementById('main-product-image');

  const colorBoxes = document.querySelectorAll('.color-box');

  /* ======================================================
     PRICE RENDER (SINGLE SOURCE OF TRUTH)
  ====================================================== */
  function renderPrice(price, offerPrice) {
  const priceBlock = document.getElementById("price-block");
  const mobilePriceEl = document.getElementById("mobile-current-price");

  if (price == null) return;

  // Desktop price
  if (priceBlock) {
    if (offerPrice && offerPrice < price) {
      priceBlock.innerHTML = `
        <span class="text-gray-500 line-through" id="base-price">â‚¹${price}</span>
        <span class="text-3xl font-bold text-emerald-400" id="current-price">â‚¹${offerPrice}</span>
      `;
    } else {
      priceBlock.innerHTML = `
        <span class="text-3xl font-bold text-white" id="current-price">â‚¹${price}</span>
      `;
    }
  }

  // ðŸ“± Mobile sticky CTA price (ALWAYS final price)
  if (mobilePriceEl) {
    mobilePriceEl.textContent = `â‚¹${offerPrice && offerPrice < price ? offerPrice : price}`;
  }
}

  /* ======================================================
     INITIAL LOAD â†’ BASE VARIANT PRICE
  ====================================================== */
  renderPrice(BASE_PRICE.price, BASE_PRICE.offer_price);

  /* ======================================================
     1ï¸âƒ£ COLOR IMAGE + PRICE (HOVER + CLICK)
  ====================================================== */
  colorBoxes.forEach(box => {
    const colorId = box.dataset.colorId;
    const variant = VARIANTS.find(v => String(v.color) === String(colorId));
    if (!variant) return;

    const updateUI = () => {
      /* ðŸ–¼ IMAGE UPDATE */
      if (variant.images && variant.images.length > 0) {
        // Desktop
        if (mainImage) {
          mainImage.src = variant.images[0];
        }

        // Mobile
        const mobileSlides = document.querySelectorAll('.mobile-slide');
        mobileSlides.forEach(slide => {
          slide.classList.remove('opacity-100');
          slide.classList.add('opacity-0');
        });

        if (mobileSlides[0]) {
          mobileSlides[0].src = variant.images[0];
          mobileSlides[0].classList.remove('opacity-0');
          mobileSlides[0].classList.add('opacity-100');
        }
      }

      /* ðŸ’° PRICE UPDATE (ONLY IF DIFFERENT) */
      if (
        variant.price !== BASE_PRICE.price ||
        variant.offer_price !== BASE_PRICE.offer_price
      ) {
        renderPrice(variant.price, variant.offer_price);
      } else {
        renderPrice(BASE_PRICE.price, BASE_PRICE.offer_price);
      }

      /* âœ¨ UI GLOW */
      colorBoxes.forEach(b =>
        b.classList.remove('ring-4', 'ring-emerald-400', 'scale-110')
      );

      box.classList.add('ring-4', 'ring-emerald-400', 'scale-110');
      setTimeout(() => box.classList.remove('scale-110'), 200);
    };

    box.addEventListener('mouseenter', updateUI);
    box.addEventListener('click', updateUI);
  });

  /* ======================================================
     2ï¸âƒ£ RECENTLY VIEWED (SESSION)
  ====================================================== */
  let viewed = JSON.parse(sessionStorage.getItem(RV_KEY) || '[]');

  viewed = viewed.filter(p => p.id !== PRODUCT_ID);
  viewed.unshift({
    id: PRODUCT_ID,
    name: PRODUCT_NAME,
    price: BASE_PRICE.offer_price || BASE_PRICE.price
  });

  viewed = viewed.slice(0, 6);
  sessionStorage.setItem(RV_KEY, JSON.stringify(viewed));

  const rvContainer = document.getElementById('recently-viewed');
  if (rvContainer && viewed.length > 1) {
    rvContainer.innerHTML = '';
    viewed.slice(1).forEach(p => {
      rvContainer.innerHTML += `
        <div class="min-w-[160px] bg-white/5 rounded-xl p-3">
          <p class="text-sm text-white">${p.name}</p>
          <p class="text-emerald-400 text-sm">â‚¹${p.price}</p>
        </div>
      `;
    });
  }

  /* ======================================================
     3ï¸âƒ£ GA4 + META VIEW EVENT
  ====================================================== */
  window.addEventListener('load', () => {
    const trackPrice = BASE_PRICE.offer_price || BASE_PRICE.price;

    if (window.gtag) {
      gtag('event', 'view_item', {
        currency: 'INR',
        value: trackPrice,
        items: [{
          item_id: PRODUCT_ID,
          item_name: PRODUCT_NAME
        }]
      });
    }

    if (window.fbq) {
      fbq('track', 'ViewContent', {
        content_ids: [PRODUCT_ID],
        content_name: PRODUCT_NAME,
        value: trackPrice,
        currency: 'INR'
      });
    }
  });

  /* ======================================================
     4ï¸âƒ£ ADD TO CART EVENTS
  ====================================================== */
  document
    .querySelectorAll('form[action*="add_to_cart"]')
    .forEach(form => {
      form.addEventListener('submit', () => {
        const trackPrice = BASE_PRICE.offer_price || BASE_PRICE.price;

        if (window.gtag) {
          gtag('event', 'add_to_cart', {
            currency: 'INR',
            value: trackPrice,
            items: [{
              item_id: PRODUCT_ID,
              item_name: PRODUCT_NAME
            }]
          });
        }

        if (window.fbq) {
          fbq('track', 'AddToCart', {
            value: trackPrice,
            currency: 'INR'
          });
        }
      });
    });

  /* ======================================================
     5ï¸âƒ£ WISHLIST HEART ANIMATION
  ====================================================== */
  const wishlistBtn = document.getElementById('wishlist-btn');
  const heart = document.getElementById('heart');

  wishlistBtn?.addEventListener('click', () => {
    if (!heart) return;
    heart.textContent = heart.textContent === 'â™¡' ? 'â¤ï¸' : 'â™¡';
    heart.classList.add('scale-125');
    setTimeout(() => heart.classList.remove('scale-125'), 200);
  });

  /* ======================================================
     6ï¸âƒ£ DESKTOP THUMBNAIL â†’ MAIN IMAGE
  ====================================================== */
  const thumbImages = document.querySelectorAll('.thumb-img');

  thumbImages.forEach(thumb => {
    thumb.addEventListener('click', () => {
      const newSrc = thumb.dataset.thumb;
      if (!newSrc || !mainImage) return;

      mainImage.src = newSrc;

      thumbImages.forEach(t =>
        t.classList.remove('ring-2', 'ring-emerald-400', 'opacity-100')
      );

      thumb.classList.add('ring-2', 'ring-emerald-400', 'opacity-100');
    });
  });

  /* ======================================================
     7ï¸âƒ£ MOBILE IMAGE CAROUSEL
  ====================================================== */
  const slides = document.querySelectorAll(".mobile-slide");
  const nextBtn = document.querySelector(".mobile-nav.next");
  const prevBtn = document.querySelector(".mobile-nav.prev");

  if (slides.length) {
    let index = 0;

    const showSlide = (i) => {
      slides.forEach(slide => {
        slide.classList.remove("opacity-100");
        slide.classList.add("opacity-0");
      });
      slides[i].classList.remove("opacity-0");
      slides[i].classList.add("opacity-100");
    };

    nextBtn?.addEventListener("click", () => {
      index = (index + 1) % slides.length;
      showSlide(index);
    });

    prevBtn?.addEventListener("click", () => {
      index = (index - 1 + slides.length) % slides.length;
      showSlide(index);
    });
  }

  /* ======================================================
     8ï¸âƒ£ MOBILE DOUBLE TAP ZOOM
  ====================================================== */
  let lastTap = 0;

  document.querySelectorAll('.mobile-slide').forEach(slide => {
    slide.addEventListener('touchend', () => {
      const now = Date.now();
      const delta = now - lastTap;

      if (delta < 300 && delta > 0) {
        document
          .querySelectorAll('.mobile-slide')
          .forEach(s => s.classList.remove('zoomed'));

        slide.classList.toggle('zoomed');
      }

      lastTap = now;
    });
  });

})();
</script>
{% endblock %}