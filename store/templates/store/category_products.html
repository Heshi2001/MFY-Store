{% extends "store/base.html" %}
{% load static %}

{% block title %}{{ category.name }} | MFY Store{% endblock %}

{% block content %}

<div x-data="searchComponent()" class="pt-[var(--navbar-height,4.5rem)] bg-black min-h-screen text-white">

<!-- ‚úÖ Category Header (Compact Height) -->
<section class="relative text-center border-b border-gray-800">
  {% if category.image %}
    <!-- Category Image -->
    <div class="relative h-32 sm:h-40 md:h-48 overflow-hidden">
      <img src="{{ category.image.url }}"
           alt="{{ category.name }} Banner"
           class="w-full h-full object-cover opacity-85">
      <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
    </div>
  {% elif category.parent and category.parent.image %}
    <!-- Fallback: Parent Category Image -->
    <div class="relative h-32 sm:h-40 md:h-48 overflow-hidden">
      <img src="{{ category.parent.image.url }}"
           alt="{{ category.parent.name }} Banner"
           class="w-full h-full object-cover opacity-85">
      <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
    </div>
  {% else %}
    <!-- No Image -->
    <div class="h-28 sm:h-36 bg-gray-900 flex items-center justify-center">
      <p class="text-gray-500 italic">No banner image available</p>
    </div>
  {% endif %}

  <!-- Overlay Text -->
  <div class="absolute inset-0 flex flex-col justify-center items-center z-10">
    <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-[#00C897] drop-shadow-md">
      {{ category.name }}
    </h1>
    <p class="text-gray-300 mt-1 text-xs sm:text-sm md:text-base">
      Explore products under ‚Äú{{ category.name }}‚Äù
    </p>
  </div>
</section>
`
  <!-- Sort & Filter Bar -->
  <div class="flex justify-between items-center px-4 sm:px-8 py-4 border-b border-gray-800 sticky top-[var(--navbar-height,4.5rem)] bg-black z-30">
    <div class="flex items-center space-x-3 relative">
      <!-- SORT -->
      <button id="sort-toggle"
        class="flex items-center space-x-2 bg-gray-800 px-4 py-2 rounded-md hover:bg-[#00A07A]/40 transition">
        <i class="fa-solid fa-arrow-down-short-wide"></i>
        <span class="text-sm font-medium">Sort</span>
        <i id="sort-arrow" class="fa-solid fa-chevron-down transition-transform duration-300"></i>
      </button>

      <!-- Sort Dropdown -->
      <div id="sort-dropdown"
        class="absolute left-0 mt-2 w-48 bg-gray-900 border border-gray-700 rounded-lg shadow-lg hidden animate-fade-in z-50">
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'category_products' category.slug %}?sort=newest" hx-target="#category-product-grid" hx-swap="innerHTML">
          üïí Newest
        </button>
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'category_products' category.slug %}?sort=low-high" hx-target="#category-product-grid" hx-swap="innerHTML">
          üí∏ Price: Low ‚Üí High
        </button>
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'category_products' category.slug %}?sort=high-low" hx-target="#category-product-grid" hx-swap="innerHTML">
          üí∞ Price: High ‚Üí Low
        </button>
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'category_products' category.slug %}?sort=rating" hx-target="#category-product-grid" hx-swap="innerHTML">
          ‚≠ê Top Rated
        </button>
      </div>
    </div>

    <!-- Right side -->
    <div class="flex items-center space-x-3">
      <p class="text-sm text-gray-400 hidden md:block">Showing {{ products|length }} items</p>

      <button
        class="hidden md:flex items-center gap-2 bg-gray-800 px-3 py-2 rounded-md hover:bg-[#00A07A]/30 transition"
        @click="openDesktop()"
        aria-label="Open search"
      >
        <i class="fas fa-search"></i>
        <span class="text-sm text-gray-200">Search</span>
      </button>

      <p class="text-sm text-gray-400 md:hidden">Showing {{ products|length }} items</p>
    </div>
  </div>

  <!-- Shimmer Loader -->
  <div id="shimmer-loader" class="max-w-7xl mx-auto px-4 sm:px-8 py-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6 hidden">
    {% for i in "123456789012" %}
    <div class="animate-pulse bg-gray-800 rounded-xl overflow-hidden">
      <div class="h-48 bg-gray-700"></div>
      <div class="p-4 space-y-2">
        <div class="h-4 bg-gray-700 rounded w-3/4"></div>
        <div class="h-3 bg-gray-700 rounded w-1/2"></div>
        <div class="h-4 bg-gray-700 rounded w-1/3 mt-2"></div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- ‚úÖ Product Grid Section -->
  <div id="category-product-grid"
     class="max-w-7xl mx-auto px-4 sm:px-8 py-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6 transition-opacity duration-300">
    {% include "store/partials/_product_grid.html" %}
  </div>

<!-- Desktop Fullscreen Search Overlay (Alpine-controlled) -->
<div
  x-show="desktopOpen"
  x-cloak
  x-transition.opacity
  @keydown.escape.window="closeDesktop()"
  class="fixed inset-0 bg-black z-50 flex items-start sm:items-center justify-center p-6"
  style="backdrop-filter: blur(6px);"
>
  <div class="w-full max-w-2xl">
    <div class="relative w-full">
      <button @click="closeDesktop()" class="absolute right-0 top-0 text-gray-400 hover:text-white text-3xl p-2 z-30">
        <i class="fas fa-times"></i>
      </button>

      <form method="GET" action="{% url 'search_results' %}" class="w-full">
        <input
          id="search-box-desktop"
          name="query"
          type="text"
          autocomplete="off"
          placeholder="Search for products..."
          @input.debounce.250="onInput($event, 'desktop')"
          @focus="onFocus('desktop')"
          class="w-full rounded-full py-4 pl-6 pr-12 bg-gray-900 text-white text-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-[#00C896] transition"
        />
      </form>

      <!-- Suggestions (desktop) -->
      <div
        id="suggestions-desktop"
        class="hidden mt-3 w-full bg-gray-800 border border-gray-700 rounded-xl shadow-xl max-h-80 overflow-y-auto text-white"
      ></div>
    </div>
  </div>
</div>

<!-- Mobile bottom-fixed search bar -->
<div class="md:hidden">
  <div class="fixed bottom-0 left-0 w-full bg-gray-900 border-t border-gray-800 p-3 z-40 fixed-search">
    <form method="GET" action="{% url 'search_results' %}" class="relative">
      <div class="relative w-full">
        <input
          id="search-box-mobile"
          name="query"
          type="text"
          autocomplete="off"
          placeholder="Search for products..."
          @input.debounce.250="onInput($event, 'mobile')"
          @focus="openMobileSheet()"
          class="w-full rounded-full py-2 pl-4 pr-10 bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#00C896] transition"
        />
        <button type="submit" class="absolute right-3 top-2.5 text-gray-400 hover:text-white">
          <i class="fas fa-search"></i>
        </button>

        <!-- Mobile suggestions sheet -->
        <div
          id="suggestions-mobile"
          x-show="mobileSheetOpen"
          x-cloak
          x-transition:enter="sheet-enter sheet-enter-active"
          x-transition:leave="sheet-leave sheet-leave-active"
          @click.away="closeMobileSheet()"
          class="absolute bottom-full mb-3 left-0 w-full bg-gray-800 border border-gray-700 rounded-xl shadow-xl max-h-72 overflow-y-auto text-white z-50"
        ></div>
      </div>
    </form>
  </div>
</div>

</div>

{% endblock %}

{% block page_js %}
<script>
  const searchSuggestionsURL = "{% url 'search_suggestions' %}";
</script>
<script src="{% static 'store/js/search_suggestions.js' %}"></script>
<script src="{% static 'store/js/filters_sort_htmx.js' %}"></script>
{% endblock %}
