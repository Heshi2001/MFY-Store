{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ category.name }} - MFY</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-950 text-white">

  <!-- Navbar -->
  <nav class="bg-gray-900 shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
      <a href="{% url 'index' %}" class="text-xl font-bold text-[#00C897]">MFY</a>

      <div class="relative">
        <a href="{% url 'cart' %}" class="flex items-center space-x-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.293 2.707A1 1 0 007 17h10a1 1 0 00.894-.553L21 9M7 13V6h13" />
          </svg>
          <span class="text-sm font-medium">Cart</span>
          {% if cart_items_count > 0 %}
          <span class="absolute -top-2 -right-3 bg-red-600 text-white text-xs font-semibold px-2 py-0.5 rounded-full">
            {{ cart_items_count }}
          </span>
          {% endif %}
        </a>
      </div>
    </div>
  </nav>

  <!-- Header Banner -->
  <section class="text-center py-10 bg-gray-800">
    <h1 class="text-3xl font-bold text-[#00C897]">{{ category.name }}</h1>
    <p class="text-gray-400 mt-2">Explore all products under "{{ category.name }}"</p>
  </section>

  <!-- Product Grid -->
  <section class="max-w-7xl mx-auto px-4 py-10">
    {% if products %}
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6">
        {% for product in products %}
        <div class="bg-gray-900 rounded-2xl overflow-hidden shadow-md group relative transition transform hover:scale-105">
          <a href="{% url 'product_detail' product.id %}">
            {% if product.first_image %}
              <img src="{{ product.first_image.image.url }}" alt="{{ product.name }}"
                   class="w-full h-64 object-cover">
            {% else %}
              <div class="w-full h-64 bg-gray-700 flex items-center justify-center text-gray-400">
                No Image
              </div>
            {% endif %}
          </a>

          {% if product.discount_percent %}
          <span class="absolute top-2 left-2 bg-[#00C897] text-xs font-semibold px-2 py-1 rounded-md text-black">
            {{ product.discount_percent }}% OFF
          </span>
          {% endif %}

          <!-- Product Info -->
          <div class="p-4 text-center">
            <h3 class="font-semibold text-white truncate">{{ product.name }}</h3>
            {% if product.offer_price %}
              <p class="mt-1">
                <span class="text-[#00C897] font-bold">₹{{ product.offer_price }}</span>
                <span class="text-gray-400 line-through text-sm ml-1">₹{{ product.price }}</span>
              </p>
            {% else %}
              <p class="mt-1 text-white font-bold">₹{{ product.price }}</p>
            {% endif %}
          </div>

          <!-- Add to Cart Button -->
          <button 
            class="absolute inset-x-0 bottom-0 opacity-0 group-hover:opacity-100 translate-y-4 group-hover:translate-y-0 
                   bg-[#00C897] text-gray-900 text-sm font-semibold py-2 transition-all duration-300 ease-in-out add-to-cart-btn"
            data-product-id="{{ product.id }}">
            Add to Cart
          </button>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center text-gray-400 text-lg">No products available in this category yet.</p>
    {% endif %}
  </section>

  <!-- Add to Cart AJAX -->
  <script>
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const productId = btn.dataset.productId;

        fetch(`/add_to_cart/${productId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('Item added to cart!');
            location.reload();
          } else {
            alert('Please log in to add items to cart.');
          }
        });
      });
    });

    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
</html>
