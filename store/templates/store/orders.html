{% extends "store/base.html" %}
{% load static %}
{% block title %}My Orders | MFY Store{% endblock %}

{% block extra_head %}
<link rel="preload" href="{% static 'store/images/placeholder.png' %}" as="image">
<style>
  /* Micro animations + shimmer skeleton */
  .shimmer {
    background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.06) 50%, rgba(255,255,255,0.03) 100%);
    background-size: 200% 100%;
    animation: shimmer 1.2s linear infinite;
  }
  @keyframes shimmer { 0% { background-position: 200% 0 } 100% { background-position: -200% 0 } }

  /* subtle card entrance */
  [data-enter="fade-slide"] { transform: translateY(12px); opacity: 0; transition: all .45s cubic-bezier(.2,.9,.2,1); }
  [data-enter].is-visible { transform: translateY(0); opacity: 1; }

  /* image hover zoom */
  .product-img {
    transition: transform .35s ease, box-shadow .35s ease;
    will-change: transform;
  }
  .product-img:hover { transform: scale(1.12); box-shadow: 0 14px 28px rgba(0,0,0,0.5); }

  /* progress track */
  .progress-track { height: 8px; background: linear-gradient(90deg,#111827,#111827); border-radius: 999px; overflow: hidden; position: relative; }
  .progress-track > i { position: absolute; left: 0; top: 0; bottom: 0; width: var(--prog,0%); background: linear-gradient(90deg,#06b6d4,#3b82f6); transition: width .6s cubic-bezier(.2,.9,.2,1); display:block; }
  .progress-bar {
    width: var(--w);
   }
  /* small screens tweak */
  @media (max-width: 640px) {
    .card-grid { gap: 1rem; }
    .order-actions { justify-content: flex-start; gap: .5rem; }
  }
</style>
{% endblock %}

{% block content %}
<section class="pt-44 pb-20 bg-black text-white min-h-screen">
  <div class="max-w-6xl mx-auto px-4">

    <!-- header -->
    <header class="mb-8 text-center" aria-labelledby="orders-heading">
      <h1 id="orders-heading" class="text-4xl md:text-5xl font-extrabold tracking-tight">My Orders</h1>
      <p class="mt-2 text-gray-400">View, track and re-order your purchases.</p>
    </header>

    <!-- FILTERS + quick stats -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <nav aria-label="Order filters" class="flex items-center gap-2 overflow-auto">
        <button data-filter="all" class="filter-btn px-4 py-2 rounded-full text-sm font-semibold bg-blue-600/20 hover:bg-blue-600/30 transition">All</button>
        <button data-filter="active" class="filter-btn px-4 py-2 rounded-full text-sm font-semibold text-gray-300 hover:bg-white/5 transition">Active</button>
        <button data-filter="delivered" class="filter-btn px-4 py-2 rounded-full text-sm font-semibold text-gray-300 hover:bg-white/5 transition">Delivered</button>
        <button data-filter="cancelled" class="filter-btn px-4 py-2 rounded-full text-sm font-semibold text-gray-300 hover:bg-white/5 transition">Cancelled</button>
      </nav>

      <div class="flex items-center gap-3 text-sm text-gray-400">
        <div class="bg-black/40 border border-gray-800 rounded-2xl p-3 shadow flex items-center gap-3">
          <i class="fa-solid fa-box text-green-400 text-lg"></i>
          <div>
            <div class="text-xs text-gray-400">Orders</div>
            <div class="text-base md:text-lg font-semibold text-white">{{ orders.count }}</div>
          </div>
        </div>

        <div class="bg-black/40 border border-gray-800 rounded-2xl p-3 shadow flex items-center gap-3">
          <i class="fa-solid fa-heart text-rose-400 text-lg"></i>
          <div>
            <div class="text-xs text-gray-400">Wishlist</div>
            <div class="text-base md:text-lg font-semibold text-white">{{ wishlist_items.count }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SKELETON LOADER -->
    <div id="skeleton" class="space-y-6" aria-hidden="true">
      {% for _ in "123"|make_list %}
      <article class="bg-gray-900/50 border border-gray-800 rounded-2xl p-6 shimmer">
        <div class="flex justify-between items-center mb-4">
          <div>
            <div class="w-40 h-4 rounded bg-gray-800 shimmer"></div>
            <div class="w-28 h-3 mt-2 rounded bg-gray-800 shimmer"></div>
          </div>
          <div class="w-20 h-6 rounded bg-gray-800 shimmer"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="flex items-center gap-4">
            <div class="w-20 h-20 bg-gray-800 rounded-xl shimmer"></div>
            <div class="flex-1 space-y-2">
              <div class="h-4 rounded bg-gray-800 shimmer w-3/4"></div>
              <div class="h-3 rounded bg-gray-800 shimmer w-1/3"></div>
            </div>
          </div>
          <div class="col-span-1 md:col-span-2 flex items-center justify-between">
            <div class="h-4 rounded bg-gray-800 shimmer w-1/3"></div>
            <div class="h-4 rounded bg-gray-800 shimmer w-1/4"></div>
          </div>
        </div>
      </article>
      {% endfor %}
    </div>

    <!-- ORDERS GRID -->
    <div id="orders-wrap" class="space-y-6 hidden card-grid">
      {% for order in orders %}
      <article class="bg-gray-900/60 border border-gray-800 rounded-2xl p-6 md:p-8 transition transform hover:-translate-y-1"
               data-order-status="{{ order.status }}" 
               data-category="{% if order.status == 'Delivered' %}delivered{% elif order.status in 'Cancelled,Canceled' %}cancelled{% else %}active{% endif %}"
               data-enter="fade-slide" role="article" aria-labelledby="order-{{ order.id }}">
        <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
          <div>
            <p class="text-sm text-gray-400">Order #<span class="font-semibold text-gray-200">{{ order.id }}</span></p>
            <p id="order-{{ order.id }}" class="text-gray-300 font-medium">Placed on {{ order.created_at|date:"M d, Y" }}</p>
            <p class="text-xs text-gray-500 mt-1">
              Estimated: {{ order.auto_estimated_delivery|date:"M d, Y" }}
            </p>
          </div>

          <div class="flex items-center gap-3">
            <!-- status badge -->
            <span class="px-3 py-1 rounded-full text-sm font-semibold
              {% if order.status == 'Delivered' %} bg-green-500/20 text-green-300
              {% elif order.status == 'Shipped' or order.status == 'Out for Delivery' %} bg-blue-500/20 text-blue-300
              {% elif order.status == 'Pending' or order.status == 'Processing' %} bg-yellow-500/20 text-yellow-300
              {% else %} bg-gray-700 text-gray-300
              {% endif %}
            ">
              {{ order.status }}
            </span>
            <a href="{% url 'order_detail' order.id %}" class="text-sm font-medium text-blue-400 hover:underline">Details ↗</a>
          </div>
        </header>

        <!-- items -->
        <div class="divide-y divide-gray-800">
          {% for item in order.items.all %}
          <div class="py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
              <a href="{{ item.product.get_absolute_url }}" class="block w-20 h-20 rounded-xl overflow-hidden shrink-0">
                <img src="{{ item.product.get_main_image_url }}" alt="{{ item.product.name }}" loading="lazy"
                     class="w-full h-full object-cover product-img" />
              </a>
              <div>
                <a href="{{ item.product.get_absolute_url }}" class="text-lg font-semibold text-white hover:underline">
                  {{ item.product.name }}
                </a>
                <p class="text-sm text-gray-400 mt-1">Qty: {{ item.quantity }} • ₹{{ item.total_price|floatformat:2 }}</p>
                {% if item.variant %}
                <p class="text-xs text-gray-500 mt-1">Variant: {{ item.variant }}</p>
                {% endif %}
              </div>
            </div>

  <div class="flex items-center gap-4 order-actions">
  <!-- progress + percentage -->
  <div class="w-56 md:w-80">
    <div class="text-xs text-gray-400 mb-2">Progress</div>

    <div class="progress-track rounded-full" aria-hidden="true"
         style="--prog: {{ order.delivery_progress }}%;">
      <i style="--w: {{ order.delivery_progress }}%;"
         class="block h-1 bg-blue-500 progress-bar"></i>
    </div>

    <!-- Updated status labels -->
    <div class="flex justify-between text-[10px] md:text-xs text-gray-500 mt-1 whitespace-nowrap gap-3">
      <span>Pending</span>
      <span>Processing</span>
      <span>Shipped</span>
      <span>Out</span>
      <span>Delivered</span>
    </div>

  </div>
</div>

              <!-- Buy Again / Track -->
              <div class="flex items-center gap-2">
                <button class="buy-again-btn inline-flex items-center px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold text-sm"
                        data-product-id="{{ item.product.id }}" aria-label="Buy again {{ item.product.name }}">
                  <i class="fa-solid fa-cart-plus mr-2"></i> Buy Again
                </button>

                {% if order.status != "Delivered" %}
                <a href="{% url 'order_detail' order.id %}" class="inline-flex items-center px-3 py-2 rounded-lg bg-transparent border border-gray-800 text-sm text-gray-300 hover:bg-white/3">Track</a>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- footer summary -->
        <footer class="flex items-center justify-between mt-6 pt-4 border-t border-gray-800">
          <div class="text-sm text-gray-400">Items: {{ order.items.count }} • Payment: {{ order.payment_status|default:"-" }}</div>
          <div class="text-right">
            <div class="text-gray-400 text-sm">Total</div>
            <div class="text-white font-extrabold text-lg">₹{{ order.total_price|floatformat:2 }}</div>
          </div>
        </footer>
      </article>
      {% endfor %}
    </div>

    <!-- no orders fallback -->
    {% if not orders %}
      <div class="py-12 text-center text-gray-400">
        <p class="text-xl">You haven't placed any orders yet.</p>
        <p class="mt-3">Check out our <a href="/products/" class="text-blue-400 hover:underline">products</a> and make your first purchase.</p>
      </div>
    {% endif %}
  </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
  // Utility to add visibility animation on scroll
  (function () {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) e.target.classList.add('is-visible');
      });
    }, { threshold: 0.08 });

    document.querySelectorAll('[data-enter="fade-slide"]').forEach(el => observer.observe(el));
  })();

  // Simulated skeleton loader then showOrders
  const skeleton = document.getElementById('skeleton');
  const ordersWrap = document.getElementById('orders-wrap');

  // Small delay to show shimmer for UX (real fetch would replace it)
  setTimeout(() => {
    if (ordersWrap) ordersWrap.classList.remove('hidden');
    if (skeleton) skeleton.classList.add('hidden');
  }, 700);

  // FILTERS
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (ev) => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-blue-600/20','text-white'));
      btn.classList.add('bg-blue-600/20','text-white');

      const filter = btn.getAttribute('data-filter');
      document.querySelectorAll('[data-category]').forEach(card => {
        if (filter === 'all') {
          card.style.display = '';
        } else if (filter === 'active') {
          card.style.display = (card.getAttribute('data-category') === 'active') ? '' : 'none';
        } else if (filter === 'delivered') {
          card.style.display = (card.getAttribute('data-category') === 'delivered') ? '' : 'none';
        } else if (filter === 'cancelled') {
          card.style.display = (card.getAttribute('data-category') === 'cancelled') ? '' : 'none';
        }
      });
    });
  });

  // BUY AGAIN - AJAX POST to your add_to_cart URL (server should accept POST)
  const ADD_TO_CART_URL = "{% url 'add_to_cart' 0 %}".replace(/0\/?$/, ''); // base path
  document.querySelectorAll('.buy-again-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const productId = btn.getAttribute('data-product-id');
      btn.disabled = true;
      btn.classList.add('opacity-70');
      try {
        const resp = await fetch(ADD_TO_CART_URL + productId + '/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ quantity: 1 })
        });
        const data = await resp.json();
        // friendly toast (simple)
        const toast = document.getElementById('cart-toast');
        const toastMsg = document.getElementById('cart-toast-message');
        if (data && data.success !== false) {
          toastMsg.textContent = data.message || 'Added to cart';
        } else {
          toastMsg.textContent = data.message || 'Could not add to cart';
        }
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 2200);
      } catch (err) {
        console.error(err);
      } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-70');
      }
    });
  });

  // small toast show/hide style (re-using base toast container)
  (function () {
    const toast = document.getElementById('cart-toast');
    const style = toast.style;
    toast.classList.remove('hidden');
    style.transition = 'all .35s ease';
    style.opacity = 0;
    setTimeout(() => { style.opacity = 0; toast.classList.add('hidden'); }, 10); // keep hidden initially
  })();
</script>
{% endblock %}
