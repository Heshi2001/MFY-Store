{% extends "store/base.html" %}
{% load static %}

{% block title %}Checkout | MFY Store{% endblock %}

{% block content %}

<style>
.saved-glow {
   color: #4ade80; /* soft green */
    background: rgba(34,197,94,0.1); /* very light green bg */
    border: 1px solid rgba(34,197,94,0.3);
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 500;
    box-shadow: 0 0 6px rgba(34,197,94,0.25); /* reduced glow */
}

@keyframes glowPulse {
  0% { opacity: 0.8; transform: scale(0.98); }
  50% { opacity: 1; transform: scale(1); }
  100% { opacity: 0.8; transform: scale(0.98); }
}
</style>

<div class="max-w-4xl mx-auto py-16 px-6 text-gray-200 pt-40 md:pt-44">
  
  <!-- Header -->
  <h1 class="text-4xl font-extrabold text-green-400 mb-8 text-center drop-shadow-md">
    Secure Checkout
  </h1>

  <!-- Modern Summary Card -->
  <div class="relative bg-gradient-to-br from-gray-900/80 via-gray-900/60 to-gray-800/50 
              border border-gray-700/70 p-8 rounded-3xl shadow-2xl 
              backdrop-blur-xl transition-all duration-500 hover:border-green-500/50 hover:shadow-[0_0_40px_rgba(34,197,94,0.25)]">

    <!-- Floating glow -->
    <div class="absolute -top-2 -right-2 w-20 h-20 bg-green-500/10 blur-2xl rounded-full"></div>

    <!-- Progress + Title Row -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 border-b border-gray-700 pb-4">
      <div class="flex items-center gap-3">
        <div class="bg-green-500/20 p-3 rounded-xl">
          <i class="fa-solid fa-bag-shopping text-green-400 text-xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-white tracking-wide">Order Summary</h2>
      </div>

<!-- ðŸ§­ Progress Steps (Cart â†’ Address â†’ Payment) -->
<div class="flex flex-wrap justify-center sm:justify-end items-center gap-3 text-sm text-gray-300">

  <!-- Step 1: Cart -->
  <a href="{% url 'cart' %}" 
     class="flex items-center gap-2 hover:text-green-400 transition-colors">
    <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-xs sm:text-sm">
      1
    </div>
    <div class="text-xs sm:text-sm">Cart</div>
  </a>

  <div class="w-6 sm:w-8 h-[2px] bg-gray-700"></div>

  <!-- Step 2: Address -->
  <a href="{% url 'account_addresses' %}" 
     class="flex items-center gap-2 hover:text-green-400 transition-colors">
    <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-xs sm:text-sm">
      2
    </div>
    <div class="text-xs sm:text-sm">Address</div>
  </a>

  <div class="w-6 sm:w-8 h-[2px] bg-gray-700"></div>

  <!-- Step 3: Payment (current step) -->
  <div class="flex items-center gap-2">
    <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-green-500 text-black flex items-center justify-center font-semibold text-xs sm:text-sm">
      3
    </div>
    <div class="font-semibold text-green-400 text-xs sm:text-sm">Payment</div>
  </div>
</div>
</div>
    <!-- Order Items -->
    <ul class="divide-y divide-gray-800">
      {% for item in items %}
      <li class="py-4 flex justify-between items-center hover:bg-gray-800/40 px-3 rounded-lg transition">
        <div class="flex items-center gap-4">
          {% if item.product.get_main_image_url %}
          <img src="{{ item.product.get_main_image_url }}" alt="{{ item.product.name }}" class="w-12 h-12 rounded-lg object-cover shadow-md border border-gray-700/60">
          {% else %}
          <img src="{% static 'img/placeholder.png' %}" alt="No Image" class="w-12 h-12 rounded-lg object-cover shadow-md border border-gray-700/60">
          {% endif %}
          <div>
            <p class="font-medium text-gray-200">{{ item.product.name }}</p>
            <p class="text-sm text-gray-500">(x{{ item.quantity }})</p>
          </div>
        </div>
        <p class="font-semibold text-white">â‚¹{{ item.total_price }}</p>
      </li>
      {% endfor %}
    </ul>

<!-- ðŸ§¾ Price Breakdown -->
<div class="mt-8 space-y-3 text-gray-300 text-lg">
  <div class="space-y-4">

    <!-- Subtotal -->
    <div class="flex justify-between">
        <span class="text-gray-400">Subtotal</span>
        <span class="font-medium">â‚¹{{ subtotal }}</span>
    </div>

    <!-- Shipping -->
    <div class="flex justify-between">
        <span class="text-gray-400">Shipping</span>
        <span class="font-medium">â‚¹{{ shipping }}</span>
    </div>

    <!-- Tax -->
    <div class="flex justify-between">
        <span class="text-gray-400">Tax</span>
        <span class="font-medium">â‚¹{{ tax }}</span>
    </div>

    <!-- Savings (if coupon applied) -->
    {% if discount_amount > 0 %}
    <div class="flex justify-between saved-glow">
      <span>You saved</span>
      <span>- â‚¹{{ discount_amount }}</span>
    </div>
    {% endif %}

    <hr class="border-gray-700">

    <!-- Total -->
    <div class="flex justify-between text-xl font-bold">
        <span>Total</span>
        <span>â‚¹{{ total }}</span>
    </div>

</div>

   <!-- ðŸŸ¢ Savings Line -->
   <p id="savings-message" class="text-sm text-green-400 mt-2 text-right hidden"></p>

    <!-- ========== Delivery & Support (NEW, dynamic preview) ========== -->
    <div id="delivery-support-block" class="mt-8 space-y-4">

      <!-- Delivery estimate card -->
      <div class="bg-gray-900/60 border border-gray-700 rounded-2xl p-4 flex items-center justify-between gap-4 hover:border-green-500/40 transition-all duration-300">
        <div class="flex items-center gap-3">
          <div class="text-2xl text-green-400"><i class="fa-solid fa-truck-fast"></i></div>
          <div>
            <div class="text-sm text-gray-400">Estimated delivery</div>
            <!-- will be filled by JS (fallback) or by context if you pass estimated_delivery -->
            <div id="estimated-delivery" class="text-lg font-semibold text-white mt-1">
              {% if estimated_delivery %}{{ estimated_delivery }}{% else %}Loadingâ€¦{% endif %}
            </div>
            <div id="shipping-method" class="text-xs text-gray-400 mt-1">
              {% if shipping_method %}{{ shipping_method }}{% else %}Standard Delivery Â· Free{% endif %}
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-400">Need help?</div>
          <div class="mt-1 flex gap-2 justify-end">
            <a href="https://wa.me/917904438276" target="_blank" class="px-3 py-1 rounded-md bg-green-600 hover:bg-green-500 text-white text-sm font-medium">
              <i class="fa-brands fa-whatsapp mr-1"></i> WhatsApp
            </a>
            <a href="mailto:euliheshicleetus2001@gmail.com" class="px-3 py-1 rounded-md bg-gray-800 border border-gray-700 text-sm text-gray-200 hover:bg-gray-800/90">
              <i class="fa-regular fa-envelope mr-1"></i> Email
            </a>
          </div>
        </div>
      </div>

      <!-- Payment trust badges -->
      <div class="flex items-center justify-center gap-6 flex-wrap">
        <!-- If you don't have static logos, you can keep these placeholders -->
          <img src="{% static 'store/images/payments/razorpay.png' %}" alt="Razorpay" class="h-6 opacity-80" />
          <img src="{% static 'store/images/payments/visa.png' %}" alt="Visa" class="h-6 opacity-80" />
          <img src="{% static 'store/images/payments/mastercard.png' %}" alt="Mastercard" class="h-6 opacity-80" />
          <img src="{% static 'store/images/payments/upi.png' %}" alt="UPI" class="h-6 opacity-80" />
      </div>

      <!-- Small reassurance text -->
      <div class="text-center text-xs text-gray-400">
        Secure payments powered by Razorpay â€¢ 30-day returns â€¢ 24/7 support
      </div>
    </div>
    <!-- ========== END Delivery & Support block ========== -->

    <!-- Pay Button -->
    <button id="pay-btn"
      class="relative w-full mt-8 py-4 text-lg font-semibold text-white rounded-xl
             bg-gradient-to-r from-green-500 via-emerald-500 to-green-600
             shadow-lg hover:shadow-[0_0_25px_rgba(34,197,94,0.6)]
             transition-transform duration-300 hover:-translate-y-1 active:scale-95">
      <i class="fa-brands fa-cc-amazon-pay mr-2"></i>
      Pay Securely with Razorpay
    </button>

    <!-- Secure Note -->
    <div class="text-sm text-gray-400 text-center mt-4 flex items-center justify-center gap-2">
      <i class="fa-solid fa-lock text-green-400"></i>
      <span>100% Secure Payments powered by Razorpay</span>
    </div>
  </div>
</div>
{% endblock content %}

{% block page_js %}
<!-- âœ… Razorpay SDK -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // ==========================================================
  // ðŸŸ¢ RAZORPAY PAYMENT SETUP
  // ==========================================================
  const payBtn = document.getElementById("pay-btn");
  let updatedOrderId = null; // Store discounted order ID if coupon applied

  if (payBtn) {
    payBtn.addEventListener("click", function (e) {
      e.preventDefault();

      if (typeof Razorpay === "undefined") {
        alert("âŒ Razorpay SDK failed to load. Please refresh the page.");
        return;
      }

      const options = {
        key: "{{ razorpay_key }}",
        amount: "{{ razorpay_order.amount }}",
        currency: "INR",
        name: "MFY Store",
        description: "Order #{{ cart.id }}",
        order_id: updatedOrderId || "{{ razorpay_order.id }}", // âœ… Use discounted order if available
        handler: function (response) {
          fetch("{% url 'payment_success' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify(response),
          })
            .then(() => {
              window.location.href = "{% url 'order_success' %}";
            })
            .catch(() => {
              alert("Payment verification failed. Please contact support.");
            });
        },
        theme: { color: "#22c55e" },
      };

      new Razorpay(options).open();
    }); 
  }

  // ==========================================================
  // ðŸšš DELIVERY ETA (fallback calculation)
  // ==========================================================
  (function () {
    const el = document.getElementById("delivery-eta") || document.getElementById("estimated-delivery");
    if (!el) return;

    const today = new Date();
    const start = new Date(today);
    start.setDate(today.getDate() + 4);
    const end = new Date(today);
    end.setDate(today.getDate() + 7);
    const fmt = (d) => d.toLocaleDateString("en-IN", { day: "numeric", month: "short" });
    el.textContent = `${fmt(start)} â€” ${fmt(end)}`;
  })();

});
</script>
{% endblock page_js %}
