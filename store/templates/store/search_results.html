{% extends "store/base.html" %}
{% load static %}

{% block title %}Search Results | MFY Store{% endblock %}

{% block content %}
<div x-data="searchComponent()" class="pt-[var(--navbar-height,4.5rem)] bg-black min-h-screen text-white">

  <!-- Header / Search Info -->
  <div class="max-w-7xl mx-auto px-4 sm:px-8 mt-6 mb-4">
    <h1 class="text-2xl font-semibold text-[#00C897] mb-1">
      Search results for: <span class="text-white">‚Äú{{ query }}‚Äù</span>
    </h1>
    <p class="text-gray-400 text-sm">Showing {{ products|length }} matching items</p>
  </div>

  <!-- Sort & Filter (same style as product page) -->
  <div class="flex justify-between items-center px-4 sm:px-8 py-4 border-b border-gray-800 sticky top-[var(--navbar-height,4.5rem)] bg-black z-30">
    <div class="flex items-center space-x-3 relative">
      <!-- SORT -->
      <button id="sort-toggle"
        class="flex items-center space-x-2 bg-gray-800 px-4 py-2 rounded-md hover:bg-[#00A07A]/40 transition">
        <i class="fa-solid fa-arrow-down-short-wide"></i>
        <span class="text-sm font-medium">Sort</span>
        <i id="sort-arrow" class="fa-solid fa-chevron-down transition-transform duration-300"></i>
      </button>

      <!-- Sort Dropdown -->
      <div id="sort-dropdown"
        class="absolute left-0 mt-2 w-48 bg-gray-900 border border-gray-700 rounded-lg shadow-lg hidden animate-fade-in z-50">
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'search_results' %}?query={{ query }}&sort=newest"
          hx-target="#product-grid" hx-swap="innerHTML">üïí Newest</button>
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'search_results' %}?query={{ query }}&sort=low-high"
          hx-target="#product-grid" hx-swap="innerHTML">üí∏ Price: Low ‚Üí High</button>
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'search_results' %}?query={{ query }}&sort=high-low"
          hx-target="#product-grid" hx-swap="innerHTML">üí∞ Price: High ‚Üí Low</button>
      </div>
    </div>

    <!-- Count + Desktop search -->
    <div class="flex items-center space-x-3">
      <p class="text-sm text-gray-400 hidden md:block">Showing {{ products|length }} items</p>
      <form method="GET" action="{% url 'search_results' %}" class="hidden md:flex items-center gap-2 bg-gray-800 px-3 py-2 rounded-md hover:bg-[#00A07A]/30 transition">
        <input name="query" type="text" value="{{ query }}" placeholder="Search again..."
          class="bg-transparent focus:outline-none text-sm text-gray-200 placeholder-gray-400 w-48">
        <button type="submit"><i class="fas fa-search text-gray-300"></i></button>
      </form>
    </div>
  </div>

  <!-- Product Grid -->
  <div id="product-grid"
       class="max-w-7xl mx-auto px-4 sm:px-8 py-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6 transition-opacity duration-300">

    {% for product in products %}
      <div class="bg-gray-900 rounded-2xl overflow-hidden shadow-md relative hover:shadow-xl transition-transform transform hover:scale-[1.02] group">

        <!-- Wishlist -->
        <button class="absolute top-2 right-2 text-white bg-black/40 hover:bg-[#00C897]/80 rounded-full p-2 transition-all wishlist-btn" data-product-id="{{ product.id }}">
          {% if product.id in wishlist_ids %}
            <i class="fa-solid fa-heart text-white"></i>
          {% else %}
            <i class="fa-regular fa-heart text-white"></i>
          {% endif %}
        </button>

        <!-- Image -->
        <a href="{% url 'product_detail' product.id %}">
          {% if product.get_main_image_url %}
            <img src="{{ product.get_main_image_url }}" alt="{{ product.name }}" class="w-full h-72 object-cover transition-transform duration-300 group-hover:scale-105">
          {% else %}
            <div class="w-full h-72 bg-gray-700 flex items-center justify-center text-gray-400">No Image</div>
          {% endif %}
        </a>

        <!-- Discount -->
        {% if product.discount_percent %}
        <span class="absolute top-2 left-2 bg-[#00C897]/90 text-white text-xs font-semibold px-3 py-1 rounded-md shadow-md animate-float">
          {{ product.discount_percent }}% OFF
        </span>
        {% endif %}

        <!-- Details -->
        <div class="p-4 space-y-1">
          <h3 class="font-semibold text-white truncate">{{ product.name }}</h3>

          {% if product.short_description %}
            <p class="text-sm text-gray-400 line-clamp-2">{{ product.short_description }}</p>
          {% endif %}

          {% if product.avg_rating > 0 %}
            <div class="flex items-center text-gray-400 text-sm space-x-1">
              <i class="fa fa-star text-yellow-400"></i>
              <span>{{ product.avg_rating }}</span>
              <span>‚Ä¢</span>
              <span>({{ product.total_reviews }})</span>
            </div>
          {% else %}
            <div class="text-gray-500 text-sm">No reviews yet</div>
          {% endif %}

          <div class="mt-1">
            {% if product.offer_price %}
              <p>
                <span class="text-gray-400 line-through text-sm">‚Çπ{{ product.price }}</span>
                <span class="text-[#00C897] font-bold ml-2 text-lg">‚Çπ{{ product.offer_price }}</span>
              </p>
            {% else %}
              <p class="text-white font-bold text-lg">‚Çπ{{ product.price }}</p>
            {% endif %}
          </div>

          {% if product.stock > 0 %}
            <p class="text-sm text-[#00C897] font-medium mt-1">In Stock ‚Ä¢ Ships in 1‚Äì2 days</p>  
          {% else %}
            <p class="text-sm font-semibold text-red-500 mt-1 animate-pulse">‚ö†Ô∏è Out of Stock</p>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p class="col-span-full text-center text-gray-400 py-12">No products found for ‚Äú{{ query }}‚Äù.</p>
    {% endfor %}
  </div>

  <!-- Back to Products -->
  <div class="text-center mt-8 mb-16">
    <a href="{% url 'products' %}" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-fuchsia-500 hover:opacity-90 rounded-md font-semibold text-white transition-all duration-300 shadow-md hover:shadow-purple-500/30">
      ‚Üê Back to All Products
    </a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'store/js/search_suggestions.js' %}"></script>
  <script src="{% static 'store/js/filters_sort_htmx.js' %}"></script>
{% endblock %}
