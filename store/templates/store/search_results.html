{% extends 'store/index.html' %}
{% load custom_filters %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-10 mb-16 relative">

  <!-- Search Box (same as index for consistency) -->
  <form method="GET" action="{% url 'search_results' %}" class="relative w-full max-w-md mx-auto mb-6">
    <input type="text" name="query" id="search-box" value="{{ query }}" placeholder="Search products..."
           class="w-full border border-gray-300 rounded-lg py-2 pl-4 pr-10 focus:outline-none focus:ring-[#006A4E] focus:border-[#006A4E]">
    <button type="submit" class="absolute right-2 top-2 text-gray-400">
      <i class="fas fa-search"></i>
    </button>
    <div id="suggestions" class="hidden absolute z-50 w-full bg-white border border-gray-200 rounded-lg mt-1 shadow-lg max-h-80 overflow-y-auto"></div>
  </form>

  <h1 class="text-2xl font-semibold text-gray-900 mb-4">
    Search results for: <span class="text-[#006A4E]">“{{ query }}”</span>
  </h1>

  <form method="GET" action="{% url 'search_results' %}" class="flex items-center gap-2 mb-6">
    <input type="hidden" name="query" value="{{ query }}">
    <label for="sort" class="text-sm text-gray-600">Sort by:</label>
    <select name="sort" id="sort" onchange="this.form.submit()" class="text-sm border-gray-300 rounded-md focus:ring-[#006A4E] focus:border-[#006A4E]">
      <option value="">Relevance</option>
      <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Price: Low to High</option>
      <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Price: High to Low</option>
      <option value="newest" {% if sort == "newest" %}selected{% endif %}>Newest</option>
    </select>
  </form>

  {% if products %}
    <div class="grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
      {% for product in products %}
        <a href="{{ product.get_absolute_url }}" class="group bg-white rounded-xl overflow-hidden border border-gray-200 shadow-sm hover:shadow-md hover:border-[#006A4E]/40 transition-all duration-200">
          <div class="relative">
            <img src="{{ product.get_image_url }}" alt="{{ product.name }}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300">
            {% if product.discount %}
              <span class="absolute top-2 left-2 bg-white/80 text-[#006A4E] px-2 py-1 rounded shadow text-sm font-semibold">{{ product.discount }}% OFF</span>
            {% endif %}
          </div>
          <div class="p-3">
            <h2 class="text-gray-800 font-medium truncate">
              {{ product.name|highlight:query }}
            </h2>
            <p class="text-gray-500 mt-1">
              {% if product.discounted_price %}
                <span class="text-gray-900 font-semibold">${{ product.discounted_price }}</span>
                <span class="line-through text-gray-400">${{ product.price }}</span>
              {% else %}
                <span class="text-gray-900 font-semibold">${{ product.price }}</span>
              {% endif %}
            </p>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500 text-center mt-10">No products found.</p>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchBox = document.getElementById("search-box");
  const suggestionsBox = document.getElementById("suggestions");
  if(!searchBox || !suggestionsBox) return;

  let debounceTimer = null;
  let activeIndex = -1;

  // ----------------------------
  // LocalStorage Recent Searches
  // ----------------------------
  const getRecentSearches = () => JSON.parse(localStorage.getItem("recentSearches") || "[]");
  const saveRecentSearch = (query) => {
    if (!query) return;
    let recent = getRecentSearches().filter(q => q.toLowerCase() !== query.toLowerCase());
    recent.unshift(query);
    if (recent.length > 6) recent = recent.slice(0,6);
    localStorage.setItem("recentSearches", JSON.stringify(recent));
  };
  const clearRecentSearches = () => {
    localStorage.removeItem("recentSearches");
    renderSuggestions([], true);
  };

  // ----------------------------
  // Render Suggestions
  // ----------------------------
  const renderSuggestions = (results=[], fromSearch=false) => {
    let html = "";
    const recent = getRecentSearches();

    if(recent.length>0 && !fromSearch){
      html += `<div class="flex items-center justify-between px-4 py-2 border-b bg-gray-50 text-gray-700 font-medium">
                 <span>Recent Searches</span>
                 <button id="clear-recent" class="text-[#006A4E] hover:underline text-sm">Clear All</button>
               </div>
               <div class="divide-y divide-gray-100">
                 ${recent.map(q=>`
                   <div class="recent-item px-4 py-2 flex items-center gap-2 cursor-pointer hover:bg-gray-100">
                     <i class="fas fa-clock text-gray-400"></i>
                     <span class="truncate">${q}</span>
                   </div>`).join("")}
               </div>`;
    }

    if(results.length>0){
      html += results.map(item=>`
        <div class="suggestion-item flex items-center gap-3 px-4 py-2 cursor-pointer hover:bg-green-50 transition-colors"
             data-name="${item.name}" data-url="${item.url}">
          <img src="${item.image || '/static/img/no-image.png'}" alt="${item.name}" class="w-10 h-10 rounded-md object-cover border flex-shrink-0">
          <div class="flex-1 min-w-0">
            <div class="font-medium text-gray-800 truncate">${item.highlight}</div>
            <div class="text-sm text-gray-500 truncate">${item.category}</div>
          </div>
          <i class="fas fa-search text-gray-400"></i>
        </div>
      `).join("");
    } else if(fromSearch){
      html += `<div class="p-3 text-gray-500 text-sm text-center">No products found</div>`;
    }

    suggestionsBox.innerHTML = html;
    suggestionsBox.classList.toggle("hidden", html.trim()==="");

    document.getElementById("clear-recent")?.addEventListener("click", clearRecentSearches);
  };

  // ----------------------------
  // Fetch Suggestions
  // ----------------------------
  const fetchSuggestions = (query) => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    if (!query.trim()) { renderSuggestions([], false); return; }

    fetch("{% url 'search_suggestions' %}?q=" + encodeURIComponent(query))
      .then(res => res.json())
      .then(data => renderSuggestions(data, true))
      .catch(err => {
        console.error("Suggestion fetch failed:", err);
        renderSuggestions([], true);
      });
  }, 300);
};

  // ----------------------------
  // Input Events
  // ----------------------------
  searchBox.addEventListener("input", e=>fetchSuggestions(e.target.value));
  searchBox.addEventListener("focus", ()=>{ if(!searchBox.value.trim()) renderSuggestions([], false); });

  document.addEventListener("click", e=>{
    if(!suggestionsBox.contains(e.target) && e.target!==searchBox) suggestionsBox.classList.add("hidden");
  });

  // ----------------------------
  // Click Events
  // ----------------------------
  suggestionsBox.addEventListener("click", e=>{
    const suggestion = e.target.closest(".suggestion-item");
    const recentItem = e.target.closest(".recent-item");
    if(e.target.closest("#clear-recent")) return;

    if(suggestion){
      saveRecentSearch(suggestion.dataset.name);
      window.location.href = suggestion.dataset.url;
    } else if(recentItem){
      const text = recentItem.textContent.trim();
      searchBox.value = text;
      saveRecentSearch(text);
      searchBox.closest("form").submit();
    }
  });

  // ----------------------------
  // Keyboard Navigation
  // ----------------------------
  searchBox.addEventListener("keydown", e=>{
    const items = Array.from(suggestionsBox.querySelectorAll(".suggestion-item, .recent-item"));
    if(!["ArrowDown","ArrowUp","Enter"].includes(e.key) || items.length===0) return;

    if(e.key==="ArrowDown") activeIndex = (activeIndex+1)%items.length;
    if(e.key==="ArrowUp") activeIndex = (activeIndex-1+items.length)%items.length;

    if(e.key==="Enter"){
      e.preventDefault();
      if(activeIndex>=0){
        const selected = items[activeIndex];
        if(selected.classList.contains("suggestion-item")){
          saveRecentSearch(selected.dataset.name);
          window.location.href = selected.dataset.url;
        } else {
          searchBox.value = selected.textContent.trim();
          saveRecentSearch(searchBox.value);
          searchBox.closest("form").submit();
        }
      }
      return;
    }

    items.forEach((item,i)=>item.classList.toggle("bg-green-100", i===activeIndex));
    if(items[activeIndex]) items[activeIndex].scrollIntoView({block:"nearest",behavior:"smooth"});
  });
});
</script>
{% endblock %}
