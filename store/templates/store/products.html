{% extends "store/base.html" %}

{% load static %}

{% block title %}Products | MFY Store{% endblock %}

{% block content %}

<div x-data="searchComponent()" class="pt-[var(--navbar-height,4.5rem)] bg-black min-h-screen text-white">
  <!-- Sort & Filter Bar -->
  <div class="flex justify-between items-center px-4 sm:px-8 py-4 border-b border-gray-800 sticky top-[var(--navbar-height,4.5rem)] bg-black z-30">
    <div class="flex items-center space-x-3 relative">
      <!-- SORT -->
      <button id="sort-toggle"
        class="flex items-center space-x-2 bg-gray-800 px-4 py-2 rounded-md hover:bg-[#00A07A]/40 transition">
        <i class="fa-solid fa-arrow-down-short-wide"></i>
        <span class="text-sm font-medium">Sort</span>
        <i id="sort-arrow" class="fa-solid fa-chevron-down transition-transform duration-300"></i>
      </button>

      <!-- Sort Dropdown -->
      <div id="sort-dropdown"
        class="absolute left-0 mt-2 w-48 bg-gray-900 border border-gray-700 rounded-lg shadow-lg hidden animate-fade-in z-50">
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'fetch_products' %}?sort=newest" hx-target="#product-grid" hx-swap="innerHTML">
          üïí Newest
        </button>
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'fetch_products' %}?sort=low-high" hx-target="#product-grid" hx-swap="innerHTML">
          üí∏ Price: Low ‚Üí High
        </button>
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'fetch_products' %}?sort=high-low" hx-target="#product-grid" hx-swap="innerHTML">
          üí∞ Price: High ‚Üí Low
        </button>
        <button class="w-full text-left px-4 py-2 hover:bg-[#00A07A]/30 text-sm"
          hx-get="{% url 'fetch_products' %}?sort=rating" hx-target="#product-grid" hx-swap="innerHTML">
          ‚≠ê Top Rated
        </button>
      </div>

      <!-- FILTER -->
      <div> <!-- ‚úÖ removed hx-get="/" safely -->
        <button id="filter-btn" type="button"
          class="flex items-center space-x-2 bg-gray-800 px-4 py-2 rounded-md hover:bg-[#00A07A]/40 transition relative">
          <i class="fa-solid fa-sliders"></i>
          <span class="text-sm font-medium">Filter</span>
          <span id="filter-badge"
            class="hidden absolute -top-1 -right-2 bg-[#00C897] text-black text-xs font-bold px-1.5 rounded-full">0</span>
        </button>
      </div>
    </div>

    <!-- Right side: showing count + desktop search icon -->
    <div class="flex items-center space-x-3">
      <!-- Showing count -->
      <p class="text-sm text-gray-400 hidden md:block">Showing {{ products|length }} items</p>

      <!-- Desktop search icon (md and up) -->
      <button
        class="hidden md:flex items-center gap-2 bg-gray-800 px-3 py-2 rounded-md hover:bg-[#00A07A]/30 transition"
        @click="openDesktop()"
        aria-label="Open search"
      >
        <i class="fas fa-search"></i>
        <span class="text-sm text-gray-200">Search</span>
      </button>

      <!-- For small screens show count + (mobile search will be bottom fixed) -->
      <p class="text-sm text-gray-400 md:hidden">Showing {{ products|length }} items</p>
    </div>
  </div>

<!-- Shimmer Loader -->
<div id="shimmer-loader" class="max-w-7xl mx-auto px-4 sm:px-8 py-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6 hidden">
  {% for i in "123456789012" %}
  <div class="animate-pulse bg-gray-800 rounded-xl overflow-hidden">
    <div class="h-48 bg-gray-700"></div>
    <div class="p-4 space-y-2">
      <div class="h-4 bg-gray-700 rounded w-3/4"></div>
      <div class="h-3 bg-gray-700 rounded w-1/2"></div>
      <div class="h-4 bg-gray-700 rounded w-1/3 mt-2"></div>
    </div>
  </div>
  {% endfor %}
</div>

<div id="product-grid"
     class="max-w-7xl mx-auto px-4 sm:px-8 py-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6 transition-opacity duration-300">

    {% for product in products %}
    <div class="bg-gray-900 rounded-2xl overflow-hidden shadow-md relative hover:shadow-xl transition-transform transform hover:scale-[1.02] group">
      
      <!-- Wishlist Button -->
      <button 
        class="absolute top-2 right-2 text-white bg-black/40 hover:bg-[#00C897]/80 rounded-full p-2 transition-all wishlist-btn"
        data-product-id="{{ product.id }}">
        {% if product.id in wishlist_ids %}
          <i class="fa-solid fa-heart text-white"></i>
        {% else %}
          <i class="fa-regular fa-heart text-white"></i>
        {% endif %}
     </button>

      <!-- Product Image -->
      <a href="{% url 'product_detail' product.id %}">
        {% if product.get_main_image_url %}
          <img src="{{ product.get_main_image_url }}" alt="{{ product.name }}" class="w-full h-72 object-cover transition-transform duration-300 group-hover:scale-105">
        {% else %}
          <div class="w-full h-72 bg-gray-700 flex items-center justify-center text-gray-400">No Image</div>
        {% endif %}
      </a>

      <!-- Discount Badge -->
      {% if product.discount_percent %}
      <span class="absolute top-2 left-2 bg-[#00C897]/90 text-white text-xs font-semibold px-3 py-1 rounded-md shadow-md animate-float">
       {{ product.discount_percent|floatformat:0 }}% OFF
      </span>
      {% endif %}

      <!-- Details -->
      <div class="p-4 space-y-1">
        <h3 class="font-semibold text-white truncate">{{ product.name }}</h3>

        {% if product.short_description %}
          <p class="text-sm text-gray-400 line-clamp-2">{{ product.short_description }}</p>
        {% endif %}

        {% if product.avg_rating > 0 %}
          <div class="flex items-center text-gray-400 text-sm space-x-1">
            <i class="fa fa-star text-yellow-400"></i>
            <span>{{ product.avg_rating }}</span>
            <span>‚Ä¢</span>
            <span>({{ product.total_reviews }})</span>
          </div>
        {% else %}
          <div class="text-gray-500 text-sm">No reviews yet</div>
        {% endif %}

        <div class="mt-1">
          {% if product.offer_price %}
            <p class="mt-2">
              <span class="text-gray-400 line-through text-sm">
                ‚Çπ{{ product.original_price }}
              </span>
              <span class="text-[#00A07A] font-bold ml-2">
                ‚Çπ{{ product.offer_price }}
              </span>
            </p>
          {% else %}
            <p class="mt-1 text-white font-bold">
              ‚Çπ{{ product.display_price }}
            </p>
          {% endif %}
        </div>

        {% if product.in_stock %}
          <p class="text-sm text-[#00C897] font-medium mt-1">
            In Stock ‚Ä¢ Ships in 1‚Äì2 days
          </p>  
        {% else %}
          <p class="text-sm font-semibold text-red-500 mt-1 animate-pulse">
            ‚ö†Ô∏è Out of Stock
          </p>
        {% endif %}

        {% if product.special_offer_text %}
        <p class="text-xs text-[#00C897] mt-1 flex items-center space-x-1 font-medium">
          <i class="fa fa-gift text-[#00C897]"></i>
          <span>{{ product.special_offer_text }}</span>
        </p>
        {% endif %}
      </div>
      <!-- Add to Cart Button -->
      <button
        class="absolute inset-x-0 bottom-0 opacity-0 group-hover:opacity-100 translate-y-4 group-hover:translate-y-0 bg-gradient-to-r from-[#00C897] to-[#00A07A] hover:from-[#00A07A] hover:to-[#008060] text-white text-sm font-semibold py-2 rounded-md transition-all duration-300 ease-in-out add-to-cart-btn"
        data-product-id="{{ product.id }}">
        Add to Cart
    </button>
    </div>
    {% empty %}
    <p class="col-span-full text-center text-gray-400 py-12">No products available.</p>
    {% endfor %}
</div>

<!-- Fade Gradient Overlay (visible during loading) -->
<div id="fade-overlay"
     class="hidden pointer-events-none fixed bottom-0 left-0 w-full h-24 bg-gradient-to-t from-black/90 via-black/40 to-transparent z-20 transition-opacity duration-500"></div>

  <!-- Infinite Scroll Trigger -->
  <div id="load-more-trigger" class="py-8 text-center">
    <button id="load-more-btn"
      hx-get="{% url 'fetch_products' %}?page=2"
      hx-trigger="click"
      hx-target="#product-grid"
      hx-swap="beforeend"
      class="px-6 py-2 bg-gradient-to-r from-purple-600 to-fuchsia-500 hover:opacity-90 rounded-md text-sm font-semibold transition-all duration-300 shadow-md hover:shadow-purple-500/30">
      Load More
    </button>
    <div id="htmx-spinner" class="hidden text-[#00C897] mt-4 animate-pulse">Loading...</div>
  </div>

  <!-- Filter Modal -->
  <div id="filter-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50">
    <div id="filter-panel"
         class="absolute right-0 bottom-0 sm:bottom-auto sm:top-0 sm:h-full sm:w-96 w-full h-[70%] bg-gray-900 rounded-t-2xl sm:rounded-none shadow-xl transform translate-y-full sm:translate-x-full transition-transform duration-300">

      <div class="flex justify-between items-center p-4 border-b border-gray-700">
        <h2 class="text-lg font-semibold">Filter</h2>
        <button id="close-filter" class="text-gray-400 hover:text-white">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>

      <div class="p-4 space-y-6 overflow-y-auto h-[calc(100%-5rem)]">
        <!-- Category -->
        <div>
          <h3 class="text-sm font-semibold text-gray-300 mb-2">Category</h3>
          <div class="space-y-2">
            {% for cat in categories %}
            <label class="flex items-center space-x-2 text-gray-400 hover:text-white cursor-pointer">
              <input type="checkbox" name="category" value="{{ cat.id }}" class="accent-[#00C897]" />
              <span>{{ cat.name }}</span>
            </label>
            {% endfor %}
          </div>
        </div>

        <!-- Price -->
        <div>
          <h3 class="text-sm font-semibold text-gray-300 mb-2">Price Range</h3>
          <div class="flex space-x-2">
            <input id="min-price" type="number" placeholder="Min" class="w-1/2 bg-gray-800 text-gray-300 p-2 rounded-md focus:ring-2 focus:ring-[#00C897]" />
            <input id="max-price" type="number" placeholder="Max" class="w-1/2 bg-gray-800 text-gray-300 p-2 rounded-md focus:ring-2 focus:ring-[#00C897]" />
          </div>
        </div>
      </div>

      <div class="flex justify-between border-t border-gray-700 p-4">
        <button id="clear-filter" type="button" class="text-gray-400 hover:text-white text-sm">Clear</button>
        <button id="apply-filter" type="button" class="bg-[#00C897] text-black font-semibold px-4 py-2 rounded-md hover:bg-[#00A07A]">Apply</button>
      </div>
    </div>
  </div>
</div>

<!-- Desktop Fullscreen Search Overlay (Alpine-controlled) -->
<div
  x-show="desktopOpen"
  x-cloak
  x-transition.opacity
  @keydown.escape.window="closeDesktop()"
  class="fixed inset-0 bg-black z-50 flex items-start sm:items-center justify-center p-6"
  style="backdrop-filter: blur(6px);"
>
  <div class="w-full max-w-2xl">
    <div class="relative w-full">
      <button @click="closeDesktop()" class="absolute right-0 top-0 text-gray-400 hover:text-white text-3xl p-2 z-30">
        <i class="fas fa-times"></i>
      </button>

      <form method="GET" action="{% url 'search_results' %}" class="w-full">
        <input
          id="search-box-desktop"
          name="query"`
          type="text"
          autocomplete="off"
          placeholder="Search for products..."
          @input.debounce.250="onInput($event, 'desktop')"
          @focus="onFocus('desktop')"
          class="w-full rounded-full py-4 pl-6 pr-12 bg-gray-900 text-white text-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-[#00C896] transition"
        />
      </form>

      <!-- Suggestions (desktop) -->
      <div
        id="suggestions-desktop"
        class="hidden mt-3 w-full bg-gray-800 border border-gray-700 rounded-xl shadow-xl max-h-80 overflow-y-auto text-white"
      ></div>
    </div>
  </div>
</div>
<!-- Mobile bottom-fixed search bar (always visible on small screens) -->
<div class="md:hidden">
  <div class="fixed bottom-0 left-0 w-full bg-gray-900 border-t border-gray-800 p-3 z-40 fixed-search">
    <form method="GET" action="{% url 'search_results' %}" class="relative">
      <div class="relative w-full">
        <input
          id="search-box-mobile"
          name="query"
          type="text"
          autocomplete="off"
          placeholder="Search for products..."
          @input.debounce.250="onInput($event, 'mobile')"
          @focus="openMobileSheet()"
          class="w-full rounded-full py-2 pl-4 pr-10 bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#00C896] transition"
        />
        <button type="submit" class="absolute right-3 top-2.5 text-gray-400 hover:text-white">
          <i class="fas fa-search"></i>
        </button>

        <!-- Mobile suggestions sheet (slides upward) -->
        <div
          id="suggestions-mobile"
          x-show="mobileSheetOpen"
          x-cloak
          x-transition:enter="sheet-enter sheet-enter-active"
          x-transition:leave="sheet-leave sheet-leave-active"
          @click.away="closeMobileSheet()"
          class="absolute bottom-full mb-3 left-0 w-full bg-gray-800 border border-gray-700 rounded-xl shadow-xl max-h-72 overflow-y-auto text-white z-50"
        ></div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block page_js %}
<script>
  const searchSuggestionsURL = "{% url 'search_suggestions' %}";
</script>

<script src="{% static 'store/js/search_suggestions.js' %}"></script>
<script src="{% static 'store/js/filters_sort_htmx.js' %}"></script>

{% endblock %}