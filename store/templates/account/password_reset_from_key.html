{% load static %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Set New Password | MFY Store</title>
  <meta name="description" content="Securely set a new password for your MFY Store account and continue shopping safely.">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MFY Theme -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            neon: '#00ff9c',
            darkbg: '#0b0f14',
            darkcard: '#111827',
          },
          boxShadow: {
            neon: '0 0 30px rgba(0,255,156,0.25)',
          }
        }
      }
    }
  </script>

  <!-- INLINE CSS -->
  <style>
    .floating-group {
      position: relative;
      padding-top: 6px;
    }

    .floating-input {
      padding-top: 1.6rem;
    }

    .floating-label {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      font-size: 0.9rem;
      pointer-events: none;
      transition: all 0.25s ease;
    }

    .floating-input:focus + .floating-label,
    .floating-input:not(:placeholder-shown) + .floating-label {
      top: -0.6rem;
      font-size: 0.75rem;
      color: #00ff9c;
      padding: 0 0.3rem;
    }

    .password-toggle {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
      cursor: pointer;
    }

    .password-toggle .eye {
      display: inline-block;
      width: 20px;
      height: 20px;
      background: currentColor;
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' fill='none' d='M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12Z'/%3E%3Ccircle cx='12' cy='12' r='3' stroke='white' stroke-width='2' fill='none'/%3E%3C/svg%3E") center / contain no-repeat;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .password-toggle.active .eye {
      transform: rotate(180deg);
      opacity: 0.7;
    }

    .password-meter {
      height: 4px;
      background: #1f2937;
      border-radius: 999px;
      overflow: hidden;
    }

    .meter-bar {
      height: 100%;
      width: 0%;
      transition: width 0.3s ease, background 0.3s ease;
    }

    .meter-weak { background: #ef4444; }
    .meter-medium { background: #facc15; }
    .meter-strong { background: #22c55e; }
  </style>
</head>

<body class="min-h-screen bg-darkbg flex items-center justify-center px-4">

<!-- Glow -->
<div class="absolute inset-0 pointer-events-none overflow-hidden">
  <div class="absolute -top-40 -left-40 w-96 h-96 bg-neon/10 blur-3xl rounded-full"></div>
  <div class="absolute bottom-0 right-0 w-96 h-96 bg-neon/5 blur-3xl rounded-full"></div>
</div>

<div class="relative w-full max-w-md bg-darkcard border border-white/10 rounded-2xl shadow-xl p-8 md:p-10">

  <!-- Header -->
  <div class="text-center mb-6">
    <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-neon/10 text-neon text-3xl shadow-neon">
      ðŸ”‘
    </div>
    <h1 class="text-2xl font-bold text-white">Choose a new password</h1>
    <p class="text-sm text-gray-400 mt-1">Secure your MFY Store account</p>
  </div>

  {% if token_fail %}
    <div class="bg-red-500/10 border border-red-500/30 text-red-400 text-sm p-4 rounded-lg text-center mb-6">
      The password reset link is invalid or expired.
    </div>

    <a href="{% url 'account_reset_password' %}"
       class="w-full bg-neon text-black font-semibold py-3 rounded-xl hover:bg-white hover:shadow-neon transition text-center block">
      Request a new link
    </a>

  {% else %}
  <form method="post" class="space-y-6">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="text-red-400 text-sm mb-3">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- Password -->
    <div class="floating-group">
      {{ form.password1|add_class:"floating-input w-full bg-darkbg border border-white/10 rounded-xl p-3 pt-5 pr-12 text-white"|attr:"placeholder:" }}
      <label class="floating-label">New Password</label>

      <button type="button" class="password-toggle" data-target="{{ form.password1.id_for_label }}">
        <span class="eye"></span>
      </button>

      <div class="password-meter mt-2">
        <div class="meter-bar"></div>
      </div>

      {% if form.password1.errors %}
        <p class="text-xs text-red-400 mt-1">{{ form.password1.errors|striptags }}</p>
      {% endif %}
    </div>

    <!-- Confirm -->
    <div class="floating-group">
      {{ form.password2|add_class:"floating-input w-full bg-darkbg border border-white/10 rounded-xl p-3 pt-5 pr-12 text-white"|attr:"placeholder:" }}
      <label class="floating-label">Confirm Password</label>

      <button type="button" class="password-toggle" data-target="{{ form.password2.id_for_label }}">
        <span class="eye"></span>
      </button>

      <p class="password-match text-sm mt-2 hidden"></p>

      {% if form.password2.errors %}
        <p class="text-xs text-red-400 mt-1">{{ form.password2.errors|striptags }}</p>
      {% endif %}
    </div>

    <button type="submit"
      class="w-full bg-neon text-black font-semibold py-3 rounded-xl hover:bg-white hover:shadow-neon transition">
      Update Password
    </button>
  </form>
  {% endif %}
</div>

<!-- INLINE JS -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  // Eye toggle
  document.querySelectorAll(".password-toggle").forEach(btn => {
    const input = document.getElementById(btn.dataset.target);
    if (!input) return;

    const show = () => { input.type = "text"; btn.classList.add("active"); };
    const hide = () => { input.type = "password"; btn.classList.remove("active"); };

    btn.addEventListener("click", () => input.type === "password" ? show() : hide());
    btn.addEventListener("touchstart", show);
    btn.addEventListener("touchend", hide);
    btn.addEventListener("mouseleave", hide);
  });

  // Strength meter
  document.querySelectorAll("input[type='password']").forEach(input => {
    const meter = input.closest(".floating-group")?.querySelector(".meter-bar");
    if (!meter) return;

    input.addEventListener("input", () => {
      let score = 0;
      const v = input.value;
      if (v.length >= 8) score++;
      if (/[A-Z]/.test(v)) score++;
      if (/[0-9]/.test(v)) score++;
      if (/[^A-Za-z0-9]/.test(v)) score++;

      meter.className = "meter-bar";
      if (score <= 1) { meter.style.width = "25%"; meter.classList.add("meter-weak"); }
      else if (score <= 3) { meter.style.width = "60%"; meter.classList.add("meter-medium"); }
      else { meter.style.width = "100%"; meter.classList.add("meter-strong"); }
    });
  });

  // Match check
  const p1 = document.getElementById("id_password1");
  const p2 = document.getElementById("id_password2");
  const msg = document.querySelector(".password-match");

  if (p1 && p2 && msg) {
    p2.addEventListener("input", () => {
      msg.classList.remove("hidden");
      if (!p2.value) msg.classList.add("hidden");
      else if (p1.value === p2.value) {
        msg.textContent = "âœ“ Passwords match";
        msg.className = "password-match text-green-400";
      } else {
        msg.textContent = "âœ— Passwords do not match";
        msg.className = "password-match text-red-400";
      }
    });
  }
});
</script>

</body>
</html>
